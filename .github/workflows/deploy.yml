name: Deploy to VPS

on:
  push:
    branches:
      - master

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 15m

          script: |
            set -e

            APP_DIR="/var/www/conecttarh/main"

            echo "==> Entrando na pasta do app"
            cd "$APP_DIR"

            echo "==> Atualizando codigo"
            git fetch --all --prune
            git reset --hard origin/master

            echo "==> Instalando dependencias (produção)"
            sudo -n /usr/local/bin/composer install \
              --no-dev \
              --optimize-autoloader \
              --no-interaction \
              --prefer-dist

            echo "==> Rodando migrations (se houver)"
            sudo -n /usr/bin/php artisan migrate --force || true

            echo "==> Limpando caches"
            sudo -n /usr/bin/php artisan optimize:clear

            echo "==> Otimizando Laravel"
            sudo -n /usr/bin/php artisan optimize

            echo "==> Permissoes (owner/grupo basico)"
            sudo -n /bin/chown -R deploy:www-data "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"
            sudo -n /bin/chmod -R 775 "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"

            echo "==> ACL (garante escrita para www-data agora e no futuro)"
            sudo -n /usr/bin/setfacl -R -m u:www-data:rwx,g:www-data:rwx "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"
            sudo -n /usr/bin/setfacl -R -d -m u:www-data:rwx,g:www-data:rwx "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"

            echo "==> Recarregando PHP-FPM"
            sudo -n /usr/bin/systemctl reload php8.2-fpm || true

            echo "==> DEPLOY FINALIZADO COM SUCESSO"

name: Deploy to VPS

on:
  push:
    branches:
      - master

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e

            APP_DIR="/var/www/conecttarh/main"

            echo "==> Entrando na pasta do app"
            cd "$APP_DIR"

            echo "==> Garantindo remoto origin"
            git remote -v || true

            echo "==> Atualizando codigo"
            git fetch --all --prune
            git reset --hard origin/master

            echo "==> Instalando dependencias (prod)"
            sudo /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            echo "==> Laravel: migracoes"
            sudo /usr/bin/php artisan migrate --force || true

            echo "==> Laravel: limpar caches e otimizar"
            sudo /usr/bin/php artisan optimize:clear
            sudo /usr/bin/php artisan optimize

            echo "==> Permissoes (somente diretorios essenciais)"
            sudo /bin/chown -R deploy:www-data "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"
            sudo find "$APP_DIR/storage" "$APP_DIR/bootstrap/cache" -type d -exec /bin/chmod 775 {} \;

            echo "==> Recarregando PHP-FPM"
            sudo /usr/bin/systemctl reload php8.2-fpm || true

            echo "==> Deploy finalizado com sucesso"
